!function(){"use strict";var e="prairie";class t{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw new Error("Хей, это же Character, ты чего? Создай нужный класс")}}class s extends t{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Swordsman"),this.attack=40,this.defence=10}}class a extends t{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Bowman"),this.attack=25,this.defence=25}}class n extends t{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Magician"),this.attack=10,this.defence=40}}class i extends t{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Vampire"),this.attack=25,this.defence=25}}class l extends t{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Undead"),this.attack=40,this.defence=10}}class r extends t{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Daemon"),this.attack=10,this.defence=10}}function c(e,t,s){const a=[],n=function*(e,t){for(;;){const s=Math.floor(Math.random()*t+1),a=Math.floor(Math.random()*e.length);yield new e[a](s)}}(e,t);for(let e=0;e<s;e+=1)a.push(n.next().value);return a}class o{constructor(e,s){if(!(e instanceof t))throw new Error("character must be instance of Character or its children");if("number"!=typeof s)throw new Error("position must be a number");this.character=e,this.position=s}}const h=new class{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const s=document.createElement("div");s.classList.add("cell","map-tile","map-tile-"+(t=e,this.boardSize,0===t?"top-left":t>0&&t<7?"top":7===t?"top-right":t%8==0&&56!==t?"left":56===t?"bottom-left":t>56&&t<63?"bottom":t%8==7&&63!==t?"right":63===t?"bottom-right":"center")),s.addEventListener("mouseenter",(e=>this.onCellEnter(e))),s.addEventListener("mouseleave",(e=>this.onCellLeave(e))),s.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(s)}var t;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const n=document.createElement("div");n.classList.add("health-level");const i=document.createElement("div");i.classList.add("health-level-indicator","health-level-indicator-"+((t=s.character.health)<15?"critical":t<50?"normal":"high")),i.style.width=`${s.character.health}%`,n.appendChild(i),a.appendChild(n),e.appendChild(a)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((s=>{const a=this.cells[e],n=document.createElement("span");n.textContent=t,n.classList.add("damage"),a.appendChild(n),n.addEventListener("animationend",(()=>{a.removeChild(n),s()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}};h.bindToDOM(document.querySelector("#game-container"));const d=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),u=new class{constructor(e,t){this.gamePlay=e,this.stateService=t}init(){this.gamePlay.drawUi(e);const t=[i,l,r],h=[],d=c([a,s,n],3,4),u=c(t,3,4),m=[],v=[];!function(){for(let e=0;e<64;)e%2==0?(m.push(e),e+=1):(m.push(e),e+=7)}(),function(){for(let e=6;e<64;)e%2==0?(v.push(e),e+=1):(v.push(e),e+=7)}();let f=m,L=v;function C(){let e=0,t=0;return e=Math.floor(Math.random()*f.length),t=f[e],f.includes(f[e])&&(f=f.filter((t=>t!==f[e]))),t}function p(){let e=0,t=0;return e=Math.floor(Math.random()*L.length),t=L[e],L.includes(L[e])&&(L=L.filter((t=>t!==L[e]))),t}for(let e=0;e<d.length;e++){const t=new o(d[e],C());h.push(t)}for(let e=0;e<u.length;e++){const t=new o(u[e],p());h.push(t)}this.gamePlay.redrawPositions(h),this.characters=h,this.addCellListeners()}addCellListeners(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this))}onCellClick(e){}onCellEnter(e){const t=this.checkCharacterInCell(e);t&&this.gamePlay.showCellTooltip(`🎖 ${t.character.level} ⚔ ${t.character.attack} 🛡 ${t.character.defence} ❤ ${t.character.health}`,e)}onCellLeave(e){this.checkCharacterInCell(e)&&this.gamePlay.hideCellTooltip(e)}checkCharacterInCell(e){return this.characters.find((t=>t.position===e))}}(h,d);u.init()}();