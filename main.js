!function(){"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const a=document.createElement("div");a.classList.add("cell","map-tile","map-tile-"+(t=e,this.boardSize,0===t?"top-left":t>0&&t<7?"top":7===t?"top-right":t%8==0&&56!==t?"left":56===t?"bottom-left":t>56&&t<63?"bottom":t%8==7&&63!==t?"right":63===t?"bottom-right":"center")),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}var t;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const r=document.createElement("div");r.classList.add("health-level");const c=document.createElement("div");c.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),c.style.width=`${a.character.health}%`,r.appendChild(c),s.appendChild(r),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],r=document.createElement("span");r.textContent=t,r.classList.add("damage"),s.appendChild(r),r.addEventListener("animationend",(()=>{s.removeChild(r),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var t={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw new Error("Хей, это же Character, ты чего? Создай нужный класс")}}class s extends a{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"swordsman"),this.attack=40,this.defence=10,this.moveDistance=4,this.attackDistance=1}}class r extends a{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bowman"),this.attack=25,this.defence=25,this.moveDistance=2,this.attackDistance=2}}class c extends a{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"magician"),this.attack=10,this.defence=40,this.moveDistance=1,this.attackDistance=4}}class i extends a{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"vampire"),this.attack=25,this.defence=25,this.moveDistance=2,this.attackDistance=2}}class h extends a{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"undead"),this.attack=40,this.defence=10,this.moveDistance=4,this.attackDistance=1}}class n extends a{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"daemon"),this.attack=10,this.defence=10,this.moveDistance=1,this.attackDistance=4}}function l(e,t,a){const s=[],r=function*(e,t){for(;;){const a=Math.floor(Math.random()*t+1),s=Math.floor(Math.random()*e.length);yield new e[s](a)}}(e,t);for(let e=0;e<a;e+=1)s.push(r.next().value);return s}class o{constructor(e,t){if(!(e instanceof a))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class d{constructor(e){if(null!==e){const t=[];for(let a=0;a<e.length;a+=1)t.push(e[a]);this.characters=t}}}class m{constructor(){this.bestPoints=0,this.gameData=null}saveBestPoints(e){e>this.bestPoints&&(this.bestPoints=e)}saveDataGame(e){return this.gameData={level:e.level,turn:e.turn,points:e.points,userTeam:e.userTeam,compTeam:e.compTeam,characters:e.characters},this.gameData}}var u="auto",p="pointer",v="crosshair",f="not-allowed";function C(e,t,a){let s=null;const r=new Set,c=t;"move"===a&&(s=e.character.moveDistance),"attack"===a&&(s=e.character.attackDistance);let i=c,h=c,n=c,l=c,o=c,d=c,m=c,u=c;for(let e=0;e<s;e+=1)i>=8&&(i-=8,r.add(i)),h>=8&&h%8!=7&&(h-=7,r.add(h)),n%8!=7&&(n+=1,r.add(n)),l<=56&&l%8!=7&&(l+=9,r.add(l)),o<=56&&(o+=8,r.add(o)),d<=56&&d%8!=0&&(d+=7,r.add(d)),m%8!=0&&(m-=1,r.add(m)),u>8&&u%8!=0&&(u-=9,r.add(u));if("attack"===a){const e=Math.floor(i/8),t=Math.floor(o/8),a=m%8,s=n%8;for(let c=e;c<=t;c+=1)for(let e=a;e<=s;e+=1)r.add(8*c+e)}return Array.from(r)}class g{static createClass(e,t){switch(e){case"Bowman":return new r(t);case"Swordsman":return new s(t);case"Magician":return new c(t);case"Daemon":return new n(t);case"Undead":return new h(t);case"Vampire":return new i(t);default:console.log("Sorry")}return!1}static isPlayableCharacter(e){return"bowman"===e.character.type||"magician"===e.character.type||"swordsman"===e.character.type}static compMoveRange(e,t,a){e.forEach((e=>{t.forEach((t=>{t===e&&a.push(t)}))}))}static levelUp(e){const t=e;return t.character.level+=1,g.levelUpAttackDefence(t),t.character.health+=80,t.character.health>100&&(t.character.health=100),Math.round(t.character.health),t}static levelUpAttackDefence(e){const t=e;return t.character.attack=Math.round(Math.max(t.character.attack,t.character.attack*(80+t.character.health)/100)),t.character.defence=Math.round(Math.max(t.character.defence,t.character.defence*(80+t.character.health)/100)),t}}const w=new e;w.bindToDOM(document.querySelector("#game-container"));const L=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),y=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.turn=1,this.gameState=new m,this.level=0,this.switch=1}init(){this.gamePlay.addNewGameListener(this.newGame.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this)),this.startGame()}addCellListeners(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this))}removeCellListeners(){this.gamePlay.cellEnterListeners=[],this.gamePlay.cellLeaveListeners=[],this.gamePlay.cellClickListeners=[]}startGame(){this.gamePlay.drawUi(t.prairie);const e=[i,h,n],a=[],d=[],m=[],u=l([r,s,c],3,4),p=l(e,3,4),v=[],f=[];!function(){for(let e=0;e<64;)e%2==0?(v.push(e),e+=1):(v.push(e),e+=7)}(),function(){for(let e=6;e<64;)e%2==0?(f.push(e),e+=1):(f.push(e),e+=7)}();let C=v,g=f;function w(){let e=0,t=0;return e=Math.floor(Math.random()*C.length),t=C[e],C.includes(C[e])&&(C=C.filter((t=>t!==C[e]))),t}function L(){let e=0,t=0;return e=Math.floor(Math.random()*g.length),t=g[e],g.includes(g[e])&&(g=g.filter((t=>t!==g[e]))),t}for(let e=0;e<u.length;e+=1){const t=new o(u[e],w());a.push(t),d.push(t)}for(let e=0;e<p.length;e+=1){const t=new o(p[e],L());a.push(t),m.push(t)}this.gamePlay.redrawPositions(a),this.characters=a,this.compTeam=m,this.userTeam=d,this.addCellListeners()}newGame(){this.removeCellListeners(),this.startGame()}saveGame(){this.gameState.saveDataGame(this),this.stateService.save(this.gameState),e.showError("Игра сохранена")}loadGame(){if(0===this.stateService.storage.length)return void e.showError("Нет сохраненной игры");this.cleanGameProperty();const a=this.stateService.load();this.userTeam=a.gameData.userTeam,this.compTeam=a.gameData.compTeam,this.loadGameUserTeam(this.userTeam),this.loadGameCompTeam(this.compTeam),this.userTeam=this.userCharacters,this.compTeam=this.compCharacters,this.level=a.gameData.level,this.points=a.gameData.points,this.gamePlay.drawUi(t[this.setTheme()]),[...this.userTeam,...this.compTeam].forEach(((e,t)=>{this.characters.push(new o(e,a.gameData.characters[t].position))})),this.removeCellListeners(),this.addCellListeners(),this.gamePlay.redrawPositions(this.characters),this.userTeam=[],this.userCharacters.forEach(((e,t)=>{this.userTeam.push(new o(e,a.gameData.characters[t].position))})),this.compTeam=[],this.compCharacters.forEach(((e,t)=>{this.compTeam.push(new o(e,a.gameData.characters[t].position))})),e.showError("Игра загрузилась")}loadGameCompTeam(e){this.compCharacters=[];for(let t=0;t<e.length;t+=1){const a=e[t].character.type[0].toUpperCase()+e[t].character.type.slice(1),s=this.createClass(a,e[t].character.level);s.attack=e[t].character.attack,s.defence=e[t].character.defence,s.health=e[t].character.health,this.compCharacters.push(s)}}loadGameUserTeam(e){this.userCharacters=[];for(let t=0;t<e.length;t+=1){const a=e[t].character.type[0].toUpperCase()+e[t].character.type.slice(1),s=g.createClass(a,e[t].character.level);s.attack=e[t].character.attack,s.defence=e[t].character.defence,s.health=e[t].character.health,this.userCharacters.push(s)}}cleanGameProperty(){this.level=1,this.turn=!0,this.points=0,this.userTeam=new d(null),this.compTeam=new d(null),this.characters=[],this.activeCharacterLast=null,this.activeCharacter=null,this.canAttack=null,this.canMove=null}onCellClick(e){if(this.notAllowed)throw new Error("Недопустимое действие");const t=this.checkCharacterInCell(e);if(!t||"bowman"!==t.character.type&&"swordsman"!==t.character.type&&"magician"!==t.character.type||((this.activeCharacter||0===this.activeCharacter)&&this.gamePlay.deselectCell(this.activeCharacter),this.gamePlay.selectCell(e),this.activeCharacter=e,this.activeCharacterLast=t,this.canMove=1),t||null===this.canMove||(this.gamePlay.deselectCell(this.activeCharacterLast.position),this.activeCharacterLast.position=e,this.canMove=null,this.gamePlay.deselectCell(e),this.gamePlay.redrawPositions(this.characters),this.turn=!1,this.enemyTurn()),t&&this.canMove&&("undead"===t.character.type||"daemon"===t.character.type||"vampire"===t.character.type)){const a=Math.max(this.activeCharacterLast.character.attack-t.character.defence,.1*this.activeCharacterLast.character.attack);(async()=>{await this.gamePlay.showDamage(e,a),t.character.health<=0&&this.death(this.compTeam,t),this.compTeam.length<1&&this.nextLevel(),this.gamePlay.redrawPositions(this.characters),this.turn=!1,this.enemyTurn()})(),t.character.health-=a}}onCellEnter(e){const t=this.checkCharacterInCell(e);if(t&&(this.gamePlay.showCellTooltip(`🎖 ${t.character.level} ⚔ ${t.character.attack} 🛡 ${t.character.defence} ❤ ${t.character.health}`,e),"bowman"!==t.character.type&&"swordsman"!==t.character.type&&"magician"!==t.character.type||(this.gamePlay.setCursor(p),this.notAllowed=!1)),!t&&this.canMove){const t=C(this.activeCharacterLast,this.activeCharacter,"move");t.forEach((t=>{t===e&&(this.gamePlay.setCursor(p),this.gamePlay.selectCell(e,"green"),this.notAllowed=!1)})),t.includes(e)||(this.gamePlay.setCursor(f),this.notAllowed=!0)}if(t&&this.canMove&&("undead"===t.character.type||"daemon"===t.character.type||"vampire"===t.character.type)){const t=C(this.activeCharacterLast,this.activeCharacter,"attack");t.forEach((t=>{t===e&&(this.gamePlay.setCursor(v),this.gamePlay.selectCell(e,"red"),this.notAllowed=!1)})),t.includes(e)||(this.gamePlay.setCursor(f),this.notAllowed=!0)}}onCellLeave(e){const t=this.checkCharacterInCell(e);this.gamePlay.setCursor(u),this.activeCharacterLast&&this.activeCharacterLast.position!==e&&this.gamePlay.deselectCell(e),t&&this.gamePlay.hideCellTooltip(e)}checkCharacterInCell(e){return this.characters.find((t=>t.position===e))}enemyTurn(){let t=null,a=null;if(this.compTeam.find((s=>{const r=this.characters.find((e=>e.character===s.character));if(C(r,r.position,"attack").find((e=>{const t=this.checkCharacterInCell(e);return!(!t||!g.isPlayableCharacter(t))&&(a=t,a)})),a){t=r,this.gamePlay.selectCell(t.position),this.gamePlay.selectCell(a.position,"red");const s=+Math.max(t.character.attack-a.character.defence,.1*t.character.attack).toFixed(1);return a.character.health-=s,a.character.health=+a.character.health.toFixed(1),(async()=>{await this.gamePlay.showDamage(a.position,s),this.gamePlay.deselectCell(t.position),this.gamePlay.deselectCell(a.position),a.character.health<=0&&this.death(this.userTeam,a),this.gamePlay.redrawPositions(this.characters),this.turn=!0,0===this.userTeam.length&&setTimeout((()=>{e.showError("Игра окончена!"),this.removeCellListeners()}),100)})(),t}return!1})),t)return;t=this.strongCharacter(this.compTeam);const s=C(t,t.position,"move");s.forEach(((e,t,a)=>{this.checkCharacterInCell(e)&&a.splice(t,1)}));const r=new Set;this.userTeam.find((e=>{const a=this.characters.find((t=>t.character===e.character));return C(t,a.position,"attack").forEach((e=>{r.add(e)})),!1}));const c=[];g.compMoveRange(r,s,c),0===c.length&&(r.forEach((e=>{this.userTeam.forEach((()=>{C(t,e,"attack").forEach((e=>{r.add(e)}))}))})),g.compMoveRange(r,s,c)),[t.position]=c,this.gamePlay.redrawPositions(this.characters),this.turn=!0}death(e,t){e.forEach(((e,a,s)=>{e===t.character&&s.splice(a,1)})),this.characters.forEach(((e,a,s)=>{e.character===t.character&&s.splice(a,1)})),this.userTeam.forEach(((e,a,s)=>{e.character===t.character&&s.splice(a,1)})),this.compTeam.forEach(((e,a,s)=>{e.character===t.character&&s.splice(a,1)}))}strongCharacter(e){const t=e;return t.length>1&&t.sort(((e,t)=>e.character.attack<t.character.attack?1:e.character.attack>t.character.attack?-1:0)),this.characters.find((e=>e.character===t[0].character))}nextLevel(){4===this.level&&(alert("Вы победили!"),this.removeCellListeners()),this.userTeam.forEach((e=>{g.levelUp(e)})),this.level+=1,this.gamePlay.drawUi(t[this.setTheme()]),this.characters=[],this.setCharactersArr(),this.gamePlay.redrawPositions(this.characters),this.removeCellListeners(),this.addCellListeners()}setTheme(){return 0===this.level?"prairie":1===this.level?"desert":2===this.level?"arctic":(this.level,"mountain")}setCharactersArr(){const e=[],t=[],a=l([i,h,n],3,4),s=[],r=[];!function(){for(let e=0;e<64;)e%2==0?(s.push(e),e+=1):(s.push(e),e+=7)}(),function(){for(let e=6;e<64;)e%2==0?(r.push(e),e+=1):(r.push(e),e+=7)}();let c=s,d=r;function m(){let e=0,t=0;return e=Math.floor(Math.random()*c.length),t=c[e],c.includes(c[e])&&(c=c.filter((t=>t!==c[e]))),t}function u(){let e=0,t=0;return e=Math.floor(Math.random()*d.length),t=d[e],d.includes(d[e])&&(d=d.filter((t=>t!==d[e]))),t}for(let t=0;t<this.userTeam.length;t+=1){const a=new o(this.userTeam[t].character,m());e.push(a)}for(let s=0;s<a.length;s+=1){const r=new o(a[s],u());e.push(r),t.push(r)}this.characters=e,this.compTeam=t}}(w,L);y.init()}();